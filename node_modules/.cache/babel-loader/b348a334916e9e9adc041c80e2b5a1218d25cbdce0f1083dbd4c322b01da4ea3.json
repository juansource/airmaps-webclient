{"ast":null,"code":"/* @license\n * Copyright 2020 Google LLC. All Rights Reserved.\n * Licensed under the Apache License, Version 2.0 (the 'License');\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an 'AS IS' BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { Matrix3, Quaternion, Triangle, Vector3 } from 'three';\nimport { CSS2DObject } from 'three/examples/jsm/renderers/CSS2DRenderer.js';\nimport { normalizeUnit } from '../styles/conversions.js';\nimport { parseExpressions } from '../styles/parsers.js';\nconst a = new Vector3();\nconst b = new Vector3();\nconst c = new Vector3();\nconst mat = new Matrix3();\nconst triangle = new Triangle();\nconst quat = new Quaternion();\n/**\n * The Hotspot object is a reference-counted slot. If decrement() returns true,\n * it should be removed from the tree so it can be garbage-collected.\n */\nexport class Hotspot extends CSS2DObject {\n  constructor(config) {\n    super(document.createElement('div'));\n    this.normal = new Vector3(0, 1, 0);\n    this.initialized = false;\n    this.referenceCount = 1;\n    this.pivot = document.createElement('div');\n    this.slot = document.createElement('slot');\n    this.element.classList.add('annotation-wrapper');\n    this.slot.name = config.name;\n    this.element.appendChild(this.pivot);\n    this.pivot.appendChild(this.slot);\n    this.updatePosition(config.position);\n    this.updateNormal(config.normal);\n    this.surface = config.surface;\n  }\n  get facingCamera() {\n    return !this.element.classList.contains('hide');\n  }\n  /**\n   * Sets the hotspot to be in the highly visible foreground state.\n   */\n  show() {\n    if (!this.facingCamera || !this.initialized) {\n      this.updateVisibility(true);\n    }\n  }\n  /**\n   * Sets the hotspot to be in the diminished background state.\n   */\n  hide() {\n    if (this.facingCamera || !this.initialized) {\n      this.updateVisibility(false);\n    }\n  }\n  /**\n   * Call this when adding elements to the same slot to keep track.\n   */\n  increment() {\n    this.referenceCount++;\n  }\n  /**\n   * Call this when removing elements from the slot; returns true when the slot\n   * is unused.\n   */\n  decrement() {\n    if (this.referenceCount > 0) {\n      --this.referenceCount;\n    }\n    return this.referenceCount === 0;\n  }\n  /**\n   * Change the position of the hotspot to the input string, in the same format\n   * as the data-position attribute.\n   */\n  updatePosition(position) {\n    if (position == null) return;\n    const positionNodes = parseExpressions(position)[0].terms;\n    for (let i = 0; i < 3; ++i) {\n      this.position.setComponent(i, normalizeUnit(positionNodes[i]).number);\n    }\n    this.updateMatrixWorld();\n  }\n  /**\n   * Change the hotspot's normal to the input string, in the same format as the\n   * data-normal attribute.\n   */\n  updateNormal(normal) {\n    if (normal == null) return;\n    const normalNodes = parseExpressions(normal)[0].terms;\n    for (let i = 0; i < 3; ++i) {\n      this.normal.setComponent(i, normalNodes[i].number);\n    }\n  }\n  updateSurface(forceUpdate) {\n    if (!forceUpdate && this.initialized) {\n      return;\n    }\n    const {\n      mesh,\n      tri,\n      bary\n    } = this;\n    if (mesh == null || tri == null || bary == null) {\n      return;\n    }\n    mesh.getVertexPosition(tri.x, a);\n    mesh.getVertexPosition(tri.y, b);\n    mesh.getVertexPosition(tri.z, c);\n    a.toArray(mat.elements, 0);\n    b.toArray(mat.elements, 3);\n    c.toArray(mat.elements, 6);\n    this.position.copy(bary).applyMatrix3(mat);\n    const target = this.parent;\n    target.worldToLocal(mesh.localToWorld(this.position));\n    triangle.set(a, b, c);\n    triangle.getNormal(this.normal).transformDirection(mesh.matrixWorld);\n    const scene = target.parent;\n    quat.setFromAxisAngle(a.set(0, 1, 0), -scene.yaw);\n    this.normal.applyQuaternion(quat);\n  }\n  orient(radians) {\n    this.pivot.style.transform = `rotate(${radians}rad)`;\n  }\n  updateVisibility(show) {\n    // NOTE: IE11 doesn't support a second arg for classList.toggle\n    if (show) {\n      this.element.classList.remove('hide');\n    } else {\n      this.element.classList.add('hide');\n    }\n    // NOTE: ShadyDOM doesn't support slot.assignedElements, otherwise we could\n    // use that here.\n    this.slot.assignedNodes().forEach(node => {\n      if (node.nodeType !== Node.ELEMENT_NODE) {\n        return;\n      }\n      const element = node;\n      // Visibility attribute can be configured per-node in the hotspot:\n      const visibilityAttribute = element.dataset.visibilityAttribute;\n      if (visibilityAttribute != null) {\n        const attributeName = `data-${visibilityAttribute}`;\n        // NOTE: IE11 doesn't support toggleAttribute\n        if (show) {\n          element.setAttribute(attributeName, '');\n        } else {\n          element.removeAttribute(attributeName);\n        }\n      }\n      element.dispatchEvent(new CustomEvent('hotspot-visibility', {\n        detail: {\n          visible: show\n        }\n      }));\n    });\n    this.initialized = true;\n  }\n}","map":{"version":3,"names":["Matrix3","Quaternion","Triangle","Vector3","CSS2DObject","normalizeUnit","parseExpressions","a","b","c","mat","triangle","quat","Hotspot","constructor","config","document","createElement","normal","initialized","referenceCount","pivot","slot","element","classList","add","name","appendChild","updatePosition","position","updateNormal","surface","facingCamera","contains","show","updateVisibility","hide","increment","decrement","positionNodes","terms","i","setComponent","number","updateMatrixWorld","normalNodes","updateSurface","forceUpdate","mesh","tri","bary","getVertexPosition","x","y","z","toArray","elements","copy","applyMatrix3","target","parent","worldToLocal","localToWorld","set","getNormal","transformDirection","matrixWorld","scene","setFromAxisAngle","yaw","applyQuaternion","orient","radians","style","transform","remove","assignedNodes","forEach","node","nodeType","Node","ELEMENT_NODE","visibilityAttribute","dataset","attributeName","setAttribute","removeAttribute","dispatchEvent","CustomEvent","detail","visible"],"sources":["../../src/three-components/Hotspot.ts"],"sourcesContent":["/* @license\n * Copyright 2020 Google LLC. All Rights Reserved.\n * Licensed under the Apache License, Version 2.0 (the 'License');\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an 'AS IS' BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Matrix3, Mesh, Quaternion, Triangle, Vector3} from 'three';\nimport {CSS2DObject} from 'three/examples/jsm/renderers/CSS2DRenderer.js';\n\nimport {normalizeUnit} from '../styles/conversions.js';\nimport {NumberNode, parseExpressions} from '../styles/parsers.js';\n\nimport {ModelScene} from './ModelScene.js';\n\nexport interface HotspotVisibilityDetails {\n  visible: boolean;\n}\n\n/**\n * Hotspots are configured by slot name, and this name must begin with \"hotspot\"\n * to be recognized. The position and normal strings are in the form of the\n * camera-target attribute and default to \"0m 0m 0m\" and \"0m 1m 0m\",\n * respectively.\n */\nexport interface HotspotConfiguration {\n  name: string;\n  position?: string;\n  normal?: string;\n  surface?: string;\n}\n\nconst a = new Vector3();\nconst b = new Vector3();\nconst c = new Vector3();\nconst mat = new Matrix3();\nconst triangle = new Triangle();\nconst quat = new Quaternion();\n\n/**\n * The Hotspot object is a reference-counted slot. If decrement() returns true,\n * it should be removed from the tree so it can be garbage-collected.\n */\nexport class Hotspot extends CSS2DObject {\n  public normal: Vector3 = new Vector3(0, 1, 0);\n  public surface?: string;\n  public mesh?: Mesh;\n  public tri?: Vector3;\n  public bary?: Vector3;\n  private initialized = false;\n  private referenceCount = 1;\n  private pivot = document.createElement('div');\n  private slot: HTMLSlotElement = document.createElement('slot');\n\n  constructor(config: HotspotConfiguration) {\n    super(document.createElement('div'));\n\n    this.element.classList.add('annotation-wrapper');\n\n    this.slot.name = config.name;\n\n    this.element.appendChild(this.pivot);\n    this.pivot.appendChild(this.slot);\n\n    this.updatePosition(config.position);\n    this.updateNormal(config.normal);\n    this.surface = config.surface;\n  }\n\n  get facingCamera(): boolean {\n    return !this.element.classList.contains('hide');\n  }\n\n  /**\n   * Sets the hotspot to be in the highly visible foreground state.\n   */\n  show() {\n    if (!this.facingCamera || !this.initialized) {\n      this.updateVisibility(true);\n    }\n  }\n\n  /**\n   * Sets the hotspot to be in the diminished background state.\n   */\n  hide() {\n    if (this.facingCamera || !this.initialized) {\n      this.updateVisibility(false);\n    }\n  }\n\n  /**\n   * Call this when adding elements to the same slot to keep track.\n   */\n  increment() {\n    this.referenceCount++;\n  }\n\n  /**\n   * Call this when removing elements from the slot; returns true when the slot\n   * is unused.\n   */\n  decrement(): boolean {\n    if (this.referenceCount > 0) {\n      --this.referenceCount;\n    }\n    return this.referenceCount === 0;\n  }\n\n  /**\n   * Change the position of the hotspot to the input string, in the same format\n   * as the data-position attribute.\n   */\n  updatePosition(position?: string) {\n    if (position == null)\n      return;\n    const positionNodes = parseExpressions(position)[0].terms;\n    for (let i = 0; i < 3; ++i) {\n      this.position.setComponent(\n          i, normalizeUnit(positionNodes[i] as NumberNode<'m'>).number);\n    }\n    this.updateMatrixWorld();\n  }\n\n  /**\n   * Change the hotspot's normal to the input string, in the same format as the\n   * data-normal attribute.\n   */\n  updateNormal(normal?: string) {\n    if (normal == null)\n      return;\n    const normalNodes = parseExpressions(normal)[0].terms;\n    for (let i = 0; i < 3; ++i) {\n      this.normal.setComponent(i, (normalNodes[i] as NumberNode).number);\n    }\n  }\n\n  updateSurface(forceUpdate: boolean) {\n    if (!forceUpdate && this.initialized) {\n      return;\n    }\n    const {mesh, tri, bary} = this;\n    if (mesh == null || tri == null || bary == null) {\n      return;\n    }\n\n    (mesh as any).getVertexPosition(tri.x, a);\n    (mesh as any).getVertexPosition(tri.y, b);\n    (mesh as any).getVertexPosition(tri.z, c);\n\n    a.toArray(mat.elements, 0);\n    b.toArray(mat.elements, 3);\n    c.toArray(mat.elements, 6);\n    this.position.copy(bary).applyMatrix3(mat);\n    const target = this.parent!;\n    target.worldToLocal(mesh.localToWorld(this.position));\n\n    triangle.set(a, b, c);\n    triangle.getNormal(this.normal).transformDirection(mesh.matrixWorld);\n    const scene = target.parent as ModelScene;\n    quat.setFromAxisAngle(a.set(0, 1, 0), -scene.yaw);\n    this.normal.applyQuaternion(quat);\n  }\n\n  orient(radians: number) {\n    this.pivot.style.transform = `rotate(${radians}rad)`;\n  }\n\n  updateVisibility(show: boolean) {\n    // NOTE: IE11 doesn't support a second arg for classList.toggle\n    if (show) {\n      this.element.classList.remove('hide');\n    } else {\n      this.element.classList.add('hide');\n    }\n\n    // NOTE: ShadyDOM doesn't support slot.assignedElements, otherwise we could\n    // use that here.\n    this.slot.assignedNodes().forEach((node) => {\n      if (node.nodeType !== Node.ELEMENT_NODE) {\n        return;\n      }\n\n      const element = node as HTMLElement;\n      // Visibility attribute can be configured per-node in the hotspot:\n      const visibilityAttribute = element.dataset.visibilityAttribute;\n\n      if (visibilityAttribute != null) {\n        const attributeName = `data-${visibilityAttribute}`;\n\n        // NOTE: IE11 doesn't support toggleAttribute\n        if (show) {\n          element.setAttribute(attributeName, '');\n        } else {\n          element.removeAttribute(attributeName);\n        }\n      }\n\n      element.dispatchEvent(new CustomEvent('hotspot-visibility', {\n        detail: {\n          visible: show,\n        },\n      }));\n    });\n\n    this.initialized = true;\n  }\n}"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}